让我们从一个例子开始：

## 举例

在一个名叫“纯粹理性湖”的钓场，湖水中只生活着3种鱼：

| 喜好水温 | 水温-权重 | 衰减系数 | 喜好含氧量 | 含氧-权重 | 衰减系数 |
| --- | --- | --- | --- | --- | --- |
| 水牛鱼 | 20 | - | - | - | - |
| 黄金鲈 | 19 | - | - | - | - |
| 小冠太阳鱼 | 24 | - | - | - | - |

这几种鱼喜欢不同的栖息地。小冠太阳鱼最喜欢水草，在水草间找小虫吃；黄金鲈最喜欢开阔水域，水牛鱼从湖底泥沙中滤食，大石头旁边很舒服，一般的水底也行。我们问了这几种鱼，它们说对于几种环境结构的亲和度如下：
| 环境结构 | 水牛鱼 | 黄金鲈 | 小冠太阳鱼 |
| --- | --- | --- | --- |
| 开阔水域 | 0.6 | 1 | 0.2 |
| 水草 | 0.7 | 0.8 | 1 |
| 沉木 | 0.5 | 0.7 | 0.9 |
| 桥墩 | 0.9 | 0.7 | 0.8 |
| 石头 | 1 | 0.7 | 0.6 |

其中，水牛鱼和小冠太阳鱼分别喜欢在底层水、表层水，而黄金鲈在中层水出现较多，会上下游动。它们说，对于几种水层的亲和度如下：

暂时无法在飞书文档外展示此内容

Q：这些开阔水域鱼可能抱团游来游去，我们的算法是否体现了这一点？
这一点不需要体现。原因是这些开阔水域的鱼
## 背景
中鱼-变量主从关系
推进-中鱼0.2
0.1文档：钓鱼E2E数据采集需求概述 中鱼数值-编辑、测试、迭代 中鱼数值-数据积累 中鱼数值-性能 鱼类-专家问题
概述
1. 中鱼逻辑包含控制逻辑和中鱼计算，0.2版本不会涉及控制逻辑。控制逻辑大概率会是包住中鱼计算的父逻辑，使用管道方式进行多段传递，在任意一段均可退出。中鱼计算只是其中的一段管道。在一定的前置步骤下（例如触发了玩家保底渔获），那么中鱼计算将不会触发。
2. 计算中有一部分是针对整个pond的分格计算，例如计算各种鱼的大体分布，这部分计算的较为复杂；一部分是加入了玩家信息的计算，例如饵能吸引哪几种鱼、玩家的路亚操作对鱼产生了怎样的吸引力（0.2版本不做）
    1. 针对整个pond的计算频率低，且与同服玩家数量无关，因此我们会尽可能把计算塞到这个阶段。这样的计算可以在以下几个时机触发，需要结合算力负载情况来安排：
        1. 钓场初始化时。例如钓场服务器启动、准备接客；例如钓场服被dispose，并重新初始化。
        2. 时段改变、天气改变时。光照、雨雪、温度变化会对水温、鱼对猎物能见度产生影响，从而改变中鱼的概率。
        3. 在玩家下钩饵时懒触发。这种情况下计算结果可以缓存，供其他玩家使用。如果使用这种方法，还需要对算法做进一步的细化，例如分块逐步计算。这方面届时再做讨论。
        针对整个pond的计算举例：
        1. 水温分层
        2. 含氧量分层
        3. 结构体带来的含氧量、食物可得性增加，从而对鱼栖息概率/密度的提升
        4. 合适的水温、含氧量、结构体，带来鱼的栖息/权重
        5. 鱼的历史饥饿/惊吓/信息素带来的持续影响（0.2版本不做）
    2. 针对单个玩家的计算可能有大量的并发，并且每个玩家可能每几秒请求一次，由此带来这方面的计算频率大很多。节省算力的努力主要有：
        1. 压缩这一步骤当中的计算步骤
        2. 一部分计算转移到客户端，让C代替S计算，S只做有限校验（0.2版本不做）
3. 0.2版的计算过程忽略了一部分因素，步骤大致为：
    1. 水温分层。根据模型，输入风力、气温、底温、光照度、
    2. 含氧量计算
    3. 结合结构体，做每一种鱼的自然权重初始计算+晕染
        1. 其中，自然权重是一个为节省算力而做的综合权重。可以理解为，结合了鱼的分布密度和觅食衰减得来的初始权重。进一步来说，是结合了含氧量、环境安全感、食物丰富性、温度的情况而
        2. 自然权重的计算，主要输入变量为：
            1. pond配置中，这种鱼的最大参考权重
            2. 鱼的配置中，地格类型对这种鱼的影响系数。影响系数是某一种地格，例如结构体的隐蔽性、食物丰富性、溶氧增益带来的综合系数。
            3. 各个深度的温度、溶氧量
            4. 这种鱼的喜好温度，以及温差衰减系数
            5. 这种鱼的喜好溶氧量
        3. 晕染过程，大致是对 【鱼在小范围做探索性的游弋】 以及 【鱼游到一定距离外吃饵，吃饵概率随距离而衰减】 过程的简化模拟
        4. 晕染过程和鱼的找食感官有关，有的鱼主要通过视觉找饵，受到光照、水清澈度影响；有的鱼通过嗅觉找饵，受到化学弥散衰减、水流（0.2版本不做）影响
        5. 晕染只对栖息在结构里的鱼做，开放水域鱼不做晕染
    4. 用户下饵，在饵所在位置的自然权重，用鱼对饵的亲和性做 鱼种筛选+（可能的）权重降低
    5. roll出中鱼结果
Known Issues
- 还未确定使用3d体素计算，还是用2d平面计算。用3d体素的话，带来的计算量会大一些，也会需要修改代码；所以一种做法是对平面、纵向分开看待，以避免改动过大。这在一些情况下会带来问题。例如：
暂时无法在飞书文档外展示此内容
- 计算做了大量简化，以节约算力，模拟精确性一定较低。例如把好几步 选择栖息地、集体迁移、游弋找食物、饵吸引衰减 都合并到了 自然权重计算+晕染 当中，以充分利用并行计算的效率。
- 还有很多因素没有加进来。例如食物丰度、离岸距离、噪音、人的视觉威胁、阴影等。
- 论文阅读有限，后续可能会被更好的模型代替。不过由于这块不涉及UI展示、前后端协同，替代模型时不会产生太多的工作量。这一版的模型也有一定的表达力，可以后续再提升。
新增/修改配置
字段
新增/修改
Workbook
Sheet
Type
说明
开发默认值
prob_score_ideal
增加

fish_pond

FishStock
float
（处于[stockList]数组的单个元素结构体中）
理想条件下的参考权重，表示鱼的易得性。表示在水温、溶氧、环境安全感、食物可得性完美时，这种鱼在此场次中的参考权重。其他情况下会在此基础上衰减。大部分情况下会配整数，但应为一个float参数。基本会在0~10000之间。注意条数依然保留，仅trophy鱼、活动鱼使用。
1000.0
hypolimnion_t
增加
fish_pond
PondList
float
这个场次中水的底层温度。实际世界里，水体当中这个温度随时间保持相对稳定，不值得计算。直接配之。
12.0


fish_pond


钓场各个时段的光照度



fish_pond


水体的光衰减系数。（前期可能直接用鱼的衰减系数代替，中后期需要用。基于KISS原则，0.2版本可以不做）






阳光通量。单位是lux。












这种鱼的嗅觉权重晕染系数。单位是m的倒数。例如0.83代表1m之外权重衰减17%，两米之外则会衰减31%。其实理论上这个系数只跟水流情况、饵的化学特性有关，和鱼无关。







这种鱼的嗅觉晕染最大距离，单位是m。为了计算方便，晕染距离是走格子距离，而非直线勾股距离。换句话说，晕染的最大范围是个菱形，而不是圆形。







这种鱼的视觉晕染阈值。相当于能接受的最低可见度。可参考S盘测清澈度的方式。这版本先不做，直接用







计算过程
水温分层
水温分层的含义、算法相关论文见中鱼-变量主从关系
晕染
像墨水扩散一样，从 栖息地的每个点 向 周围 进行 递归性 的 权重 辐射。
[图片]
晕染大致是对 【鱼在小范围做探索性的游弋】 以及 【鱼游到一定距离外吃饵，吃饵概率随距离而衰减】 过程的简化模拟。晕染过程和鱼的找食感官有关，有的鱼主要通过视觉找饵，受到光照、水清澈度影响；有的鱼通过嗅觉找饵，受到化学弥散衰减、水流（0.2版本不做）影响。
- 只考虑结构体向外的晕染。开阔水域鱼例如金枪鱼喜欢在没有结构体的开阔水域成群游动，这不需要向结构体内晕染。
- 晕染只会用高的覆盖低的。若递归过程中发现目标格子已经有更高的值了，这个递归分支就中断。
- 若超过了晕染最大距离（嗅觉和视觉各有最大距离，根据鱼的觅食感官而定），这个递归分支就中断。
递归算法下（应该改成循环迭代算法，见下文），伪代码：
int bleedLength
        
// 对每种鱼分别晕染，因为每种鱼的栖息不同，栖息地算出来的权重不一样，并且每种鱼的感觉器官不同，衰减系数、衰减阈值也不同
// 可以尝试做并行计算
for fishInfo in 钓场stock配置的所有鱼种：
        // 是for地图点，也就是grid，而不是for结构体的实体概念
        for 结构体点 in 地图结构体点列表：
                // 因为递归的一些写法，所以这里初始化成1。如果逻辑作改动，也可能初始化成0.
                bleedLength = 1
                // 2d则为上下左右，3d则为上下左右前后
                for neighbor in 结构体点.neighbors:
                        bleedToNeighbor(结构体点, neighbor, bleedLength)
        
func bleedToNeighbor(srcGrid, destGrid, bleedLength)->void:
        if bleedLength > fishInfo.MaxBleedDist then return
        // 检查是否低于
        if fishInfo.bUseSight:
                检查是否已经低于视觉阈值。若低于，则返回，这条递归分支终止
        if fishInfo.bUseSmell:
                检查是否已经低
        tgtProbScore = srcGrid.probScores[fishInfo] * 
        bleedToNeighbor(destGrid, neighbor, bleedLength)
        

[图片]
常见问题
- 鱼实际上在温度改变时会几乎整群迁往另一个